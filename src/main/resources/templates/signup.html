<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Spare - 회원가입</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <script>
        let currentStep = 1;
        let verifiedEmail = '';

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
            document.getElementById('step' + step).style.display = 'block';
            currentStep = step;
        }

        function sendVerificationCode() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            fetch('/api/users/verification/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email: email})
            })
            .then(response => {
                if (response.ok) {
                    alert('인증 코드가 발송되었습니다.');
                    document.getElementById('verifyEmail').value = email;
                    showStep(2);
                } else {
                    return response.text().then(text => {
                        alert('오류: ' + text);
                    });
                }
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error.message);
            });
        }

        function verifyCode() {
            const email = document.getElementById('verifyEmail').value;
            const code = document.getElementById('code').value;

            if (!code) {
                alert('인증 코드를 입력해주세요.');
                return;
            }

            fetch(`/api/users/verification/verify?email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    alert('인증이 완료되었습니다.');
                    verifiedEmail = email;
                    document.getElementById('signupEmail').value = email;
                    // 인증 코드를 회원가입 폼에 설정
                    document.getElementById('verificationCode').value = code;
                    showStep(3);
                } else {
                    return response.text().then(text => {
                        alert('인증 실패: ' + text);
                    });
                }
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error.message);
            });
        }

        function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('password').value;
            const verificationCode = document.getElementById('verificationCode').value;

            if (!password) {
                alert('비밀번호를 입력해주세요.');
                return;
            }

            fetch('/api/users/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    verificationCode: verificationCode
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('회원가입이 완료되었습니다!');
                    window.location.href = '/login';
                } else {
                    return response.text().then(text => {
                        alert('회원가입 실패: ' + text);
                    });
                }
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error.message);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 이미 로그인되어 있는지 확인
            fetch('/api/users/me', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    // 이미 로그인된 상태
                    document.querySelector('.container').innerHTML =
                        '<h2>이미 로그인되었습니다</h2>' +
                        '<p>현재 로그인된 상태입니다. 새로운 계정을 만들려면 먼저 로그아웃해주세요.</p>' +
                        '<button onclick="logout()">로그아웃</button>' +
                        '<a href="/dashboard"><button>대시보드로 이동</button></a>';
                } else {
                    showStep(1);
                }
            })
            .catch(error => {
                showStep(1);
            });
        });

        function logout() {
            fetch('/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                window.location.reload();
            });
        }
    </script>
</head>
<body>
<div class="container">
    <h2>회원가입</h2>

    <!-- Step 1: 이메일 입력 및 인증 코드 발송 -->
    <div id="step1" class="step">
        <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" id="email" name="email" required/>
            <button type="button" onclick="sendVerificationCode()">인증 코드 발송</button>
        </div>
    </div>

    <!-- Step 2: 인증 코드 확인 -->
    <div id="step2" class="step" style="display: none;">
        <div class="form-group">
            <label for="code">인증 코드</label>
            <input type="text" id="code" name="code" required/>
            <input type="hidden" id="verifyEmail" name="email"/>
            <button type="button" onclick="verifyCode()">코드 확인</button>
        </div>
        <p>입력하신 이메일로 인증 코드를 발송했습니다. 코드를 확인해주세요.</p>
    </div>

    <!-- Step 3: 회원가입 완료 -->
    <div id="step3" class="step" style="display: none;">
        <div class="form-group">
            <label for="signupEmail">이메일</label>
            <input type="email" id="signupEmail" name="email" readonly/>
        </div>
        <div class="form-group">
            <label for="password">비밀번호</label>
            <input type="password" id="password" name="password" required/>
        </div>
        <div class="form-group">
            <input type="hidden" id="verificationCode" name="verificationCode"/>
            <button type="button" onclick="signup()">회원가입 완료</button>
        </div>
    </div>

    <div class="form-group">
        <a th:href="@{/oauth2/authorization/google}">
            <button class="oauth-button">Google로 회원가입</button>
        </a>
    </div>
</div>
</body>
</html>